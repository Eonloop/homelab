---
- name: Harden and Provision Raspberry Pi 5
  hosts: rpis
  become: true
  tasks:
    # --- Provisioning Section ---
    - name: Update apt cache and upgrade all packages
      apt: 
        update_cache: yes
        upgrade: dist
        autoremove: yes

    - name: Install essential packages
      apt:
        name:
          - ufw
          - fail2ban
          - unattended-upgrades
          - htop
        state: present

    # --- Hardening Section ---      
    - name: Ensure a secure sudo user exists
      user:
        name: sysadmin
        groups: sudo
        shell: /bin/bash
        append: yes
    - name: Add SSH key for the new user
        user: sysadmin
        state: present
        key: "{{ lookup('file', '~/.ssh/id_ed25519.pub') }}"
    - name: Harden SSH configuration
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        state: present
      loop:
        - { regexp: '^PermitRootLogin', line: 'PermitRootLogin no' }
        - { regexp: '^PasswordAuthentication', line: 'PasswordAuthentication no' }
      notify: Restart SSH

    - name: Setup UFW firewall
      ufw:
        rule: allow
        port: '22'
        proto: tcp

    - name: Enable UFW
      ufw:
        state: enabled
        policy: deny

  handlers:
    - name: Restart SSH
      service:
        name: ssh
        state: restarted
